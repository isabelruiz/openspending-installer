#!/bin/bash

set -eu
prog_name=$(basename $0)

DBUSER=
DBNAME=openspending
GIT_REPO=http://github.com/openspending/openspending.git
JS_REPO=http://github.com/openspending/openspendingjs.git
TARGET_DIR=openspending
VIRTUALENV=virtualenv
CREATEDBOPTS="-E utf-8"

while [ $# -gt 0 ];
do
	case "$1" in
		--git-repo) 
		  GIT_REPO=$2
		  shift 2
		  ;;
		--js-repo)
		  JS_REPO=$2
		  shift 2
		  ;;
		--target-dir)
		  TARGET_DIR=$2
		  shift 2
		  ;;
		--db-user)
		  DBUSER=$2
		  shift 2
		  ;;
		--db-name)
		  DBNAME=$2
		  shift 2
		  ;;
    --virtualenv)
      VIRTUALENV=$2
      shift 2
      ;;
		*)
		  echo ${prog_name}: unrecognised option: $1
		  exit 1
		  ;;
    esac
done


if [ -d $TARGET_DIR ]; then
	echo ${prog_name}: Directory openspending already exists
	exit 1
fi

git clone $GIT_REPO $TARGET_DIR
cd $TARGET_DIR

# should explicitly use python2.7
$VIRTUALENV ./pyenv

set +u
source ./pyenv/bin/activate
set -u

pip install nose==1.1.2
pip install PasteScript==1.7.5

pip install -r requirements.txt -e .
git clone $JS_REPO
ln -s openspendingjs openspending/ui/public/static/openspendingjs

pip install psycopg2

if [ $DBUSER ]; then
  CREATEDBOPTS="$CREATEDBOPTS --owner $DBUSER";
fi  
createdb $CREATEDBOPTS $DBNAME;

cat development.ini_tmpl | \
	sed "s/^openspending.db.url = .*$/openspending.db.url = postgresql:\/\/${DBUSER}@localhost\/${DBNAME}/" > \
	development.ini

